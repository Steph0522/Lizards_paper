---
title: "Aldex GLM SG ASVS"
author:
- Stephanie Hereira, Centro Tlaxcala de Biología de la Conducta, UATx
- Mauricio Hernández, Doctorado en CB, Centro Tlaxcala de Biología de la Conducta, UATx
date: "`r format(Sys.time(), '%d - %m - %Y')`"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_document:
    theme: spacelab
    highlight: pygments
    toc: yes
    toc_depth: 2
    toc_float: yes
---
# Aldex GLM SG ASVS
```{r, message=FALSE, warning=FALSE, eval=FALSE}
library(ALDEx2)

otutable <- read.delim("../Data/otutable-taxonomy_ultima.txt", 
                       check.names = F) %>% 
  dplyr::select(-"taxonomy") %>% column_to_rownames(
    var = "#OTU ID")
metadata<- read.csv("../Data/Metadatos1.csv", check.names = F)
taxonomy<- read.delim("../Data/otutable-taxonomy_ultima.txt", check.names = F) %>% 
  dplyr::select("#OTU ID","taxonomy") %>% mutate(names= str_extract(taxonomy, "[^__]+$"))


#Comparisons
otutable_feces <- otutable %>% dplyr::select_at(vars(contains("M.H.")))
otutable_stomach <- otutable %>% dplyr::select_at(vars(contains("M.E.")))

otutable_feces_stomach <- cbind(otutable_feces, otutable_stomach)
conditions <- c(rep("Feces", 10), rep("Stomach", 7))

aldex_feces_stomach <- aldex(otutable_feces_stomach,
                             conditions = conditions, mc.samples = 1000, denom = "all",
                             test = "t", effect = T)

aldex_plot <- aldex_feces_stomach %>% filter(we.ep < 0.05) %>% rownames_to_column(
  var = "#OTU ID") %>% inner_join(taxonomy) %>% mutate(Type = case_when(
    diff.btw >0 ~ "Stomach",
    diff.btw <0 ~ "Feces")) %>% rownames_to_column(var = "nums") %>% mutate(taxa = paste0(nums, names))

#aldex_plot %>% ggplot(.,aes(diff.btw, taxa, fill=Type)) +geom_bar(stat = "identity")

write.table(aldex_plot, file="../Data/aldexFinal_feces_stomach.txt", sep = "\t")
# Recordatorio: de esta tabla que se descargó hay que renombrar la columna names de acuerdo
# a la taxonomia correcta que se encuentra en la columna taxonomy. Con esa tabla corregida 
# ya se puede correr los graficos en ggplot. OK 

#segundo: heces vs intestino
otutable_feces <- otutable %>% dplyr::select_at(vars(contains("M.H.")))
otutable_intestine <- otutable %>% dplyr::select_at(vars(contains("M.I.")))

otutable_feces_intestine <- cbind(otutable_feces, otutable_intestine)
conditions <- c(rep("Feces", 10), rep("Small intestine", 7))

aldex_feces_intestine <- aldex(otutable_feces_intestine,
                             conditions = conditions, mc.samples = 1000, denom = "all",
                             test = "t", effect = T)

aldex_plot_FSI <- aldex_feces_intestine %>% filter(we.ep < 0.05) %>% rownames_to_column(
  var = "#OTU ID") %>% inner_join(taxonomy) %>% mutate(Type = case_when(
    diff.btw >0 ~ "Small intestine",
    diff.btw <0 ~ "Feces")) %>% rownames_to_column(var = "nums") %>% mutate(taxa = paste0(nums, names))

#aldex_plot %>% ggplot(.,aes(diff.btw, taxa, fill=Type)) +geom_bar(stat = "identity")

write.table(aldex_plot_FSI, file="./aldexFinal_feces_intestine.txt", sep = "\t")

#tercero: heces vs rectum
otutable_feces <- otutable %>% dplyr::select_at(vars(contains("M.H.")))
otutable_rectum <- otutable %>% dplyr::select_at(vars(contains("M.R.")))

otutable_feces_rectum <- cbind(otutable_feces, otutable_rectum)
conditions <- c(rep("Feces", 10), rep("Rectum", 7))

aldex_feces_rectu  <- aldex(otutable_feces_rectum,
                               conditions = conditions, mc.samples = 1000, denom = "all",
                               test = "t", effect = T)

aldex_plot_FR <- aldex_feces_rectu %>% filter(we.ep < 0.05) %>% rownames_to_column(
  var = "#OTU ID") %>% inner_join(taxonomy) %>% mutate(Type = case_when(
    diff.btw >0 ~ "Rectum",
    diff.btw <0 ~ "Feces")) %>% rownames_to_column(var = "nums") %>% mutate(taxa = paste0(nums, names))

#aldex_plot %>% ggplot(.,aes(diff.btw, taxa, fill=Type)) +geom_bar(stat = "identity")

write.table(aldex_plot_FR, file="./aldexFinal_feces_rectum.txt", sep = "\t")

################################################################################
# CLOACA VERSUS ESTOMAGO, CLOACA VERSUS INTESTINO Y CLOACA VERSUS RECTO

#primero: cloaca vs estomago
otutable_cloaca <- otutable %>% dplyr::select_at(vars(contains("M.HC.")))
otutable_stomach <- otutable %>% dplyr::select_at(vars(contains("M.E.")))

otutable_cloaca_stomach <- cbind(otutable_cloaca, otutable_stomach)
conditions1 <- c(rep("Cloaca", 10), rep("Stomach", 7))

aldex_cloaca_stomach <- aldex(otutable_cloaca_stomach,
                             conditions = conditions1, mc.samples = 1000, denom = "all",
                             test = "t", effect = T)

aldex_plot_CS <- aldex_cloaca_stomach %>% filter(we.ep < 0.05) %>% rownames_to_column(
  var = "#OTU ID") %>% inner_join(taxonomy) %>% mutate(Type = case_when(
    diff.btw >0 ~ "Stomach",
    diff.btw <0 ~ "Cloaca")) %>% rownames_to_column(var = "nums") %>% mutate(taxa = paste0(nums, names))

#aldex_plot %>% ggplot(.,aes(diff.btw, taxa, fill=Type)) +geom_bar(stat = "identity")

write.table(aldex_plot_CS, file="./aldexFinal_cloaca_stomach.txt", sep = "\t")
# Recordatorio: de esta tabla que se descargó hay que renombrar la columna names de acuerdo
# a la taxonomia correcta que se encuentra en la columna taxonomy. Con esa tabla corregida 
# ya se puede correr los graficos en ggplot. OK 

#segundo: cloaca vs intestino
otutable_cloaca <- otutable %>% dplyr::select_at(vars(contains("M.HC.")))
otutable_intestine <- otutable %>% dplyr::select_at(vars(contains("M.I.")))

otutable_cloaca_intestine <- cbind(otutable_cloaca, otutable_intestine)
conditions <- c(rep("Cloaca", 10), rep("Small intestine", 7))

aldex_cloaca_intestine <- aldex(otutable_cloaca_intestine,
                               conditions = conditions, mc.samples = 1000, denom = "all",
                               test = "t", effect = T)

aldex_plot_CSI <- aldex_cloaca_intestine %>% filter(we.ep < 0.05) %>% rownames_to_column(
  var = "#OTU ID") %>% inner_join(taxonomy) %>% mutate(Type = case_when(
    diff.btw >0 ~ "Small intestine",
    diff.btw <0 ~ "Cloaca")) %>% rownames_to_column(var = "nums") %>% mutate(taxa = paste0(nums, names))

#aldex_plot %>% ggplot(.,aes(diff.btw, taxa, fill=Type)) +geom_bar(stat = "identity")

write.table(aldex_plot_CSI, file="./aldexFinal_cloaca_intestine.txt", sep = "\t")

#tercero: cloaca vs rectum
otutable_cloaca <- otutable %>% dplyr::select_at(vars(contains("M.HC.")))
otutable_rectum <- otutable %>% dplyr::select_at(vars(contains("M.R.")))

otutable_cloaca_rectum <- cbind(otutable_cloaca, otutable_rectum)
conditions <- c(rep("Cloaca", 10), rep("Rectum", 7))

aldex_cloaca_rectum  <- aldex(otutable_cloaca_rectum,
                            conditions = conditions, mc.samples = 1000, denom = "all",
                            test = "t", effect = T)

aldex_plot_CR <- aldex_cloaca_rectum %>% filter(we.ep < 0.05) %>% rownames_to_column(
  var = "#OTU ID") %>% inner_join(taxonomy) %>% mutate(Type = case_when(
    diff.btw >0 ~ "Rectum",
    diff.btw <0 ~ "Cloaca")) %>% rownames_to_column(var = "nums") %>% mutate(taxa = paste0(nums, names))

#aldex_plot %>% ggplot(.,aes(diff.btw, taxa, fill=Type)) +geom_bar(stat = "identity")

write.table(aldex_plot_CR, file="./aldexFinal_cloaca_rectum.txt", sep = "\t")


################################################################################
################################################################################
# Graficar (ggplot2)
aldex_plot<- aldex_feces_rectum %>% filter(we.ep<0.05) %>% rownames_to_column(
  var = "#OTU ID") %>% inner_join(taxonomy) %>% mutate(Type = case_when(
    diff.btw >0  ~"Rectum",
    diff.btw<0 ~"Feces" )) %>%rownames_to_column(var = "nums") %>%  mutate(taxa= paste0(nums, names))

aldex_plot %>% ggplot(.,aes(diff.btw, taxa, fill=Type)) +geom_bar(stat = "identity")

aldex_plot2<- aldex_feces_stomach %>% filter(we.ep<0.05) %>% rownames_to_column(
  var = "#OTU ID") %>% inner_join(taxonomy) %>% mutate(Type = case_when(
    diff.btw >0  ~"Stomach",
    diff.btw<0 ~"Feces" )) %>%rownames_to_column(var = "nums") %>%  mutate(taxa= paste0(nums, names))

aldex_plot2 %>% ggplot(.,aes(diff.btw, taxa, fill=Type)) +geom_bar(stat = "identity")+theme(
  axis.text.y = element_text(hjust =  0.5))

#Cargar las tablas obtenidas a partir del analisis aldex

Feces_Stomach_ALDEX <- read.delim("../Data/aldexFinal_feces_stomach.txt", check.names = F) %>% rename(
  rab.win.other="rab.win.Stomach") %>% mutate(compare= "Feces vs Stomach")
Feces_Intestine_ALDEX <- read.delim("aldexFinal_feces_intestine.txt", check.names = F)  %>% rename(
  rab.win.other="rab.win.Small intestine") %>% mutate(compare="Feces vs Small intestine")
Feces_Rectum_ALDEX <- read.delim("aldexFinal_feces_rectum.txt", check.names = F)  %>% rename(
  rab.win.other="rab.win.Rectum") %>% mutate(compare="Feces vs Rectum")

Cloaca_Stomach_ALDEX <- read.delim("aldexFinal_cloaca_stomach.txt", check.names = F)  %>% rename(
  rab.win.other="rab.win.Stomach") %>% mutate(compare="Cloaca vs Stomach")
Cloaca_Intestine_ALDEX <- read.delim("aldexFinal_cloaca_intestine.txt", check.names = F)  %>% rename(
    rab.win.other="rab.win.Small intestine") %>% mutate(compare="Cloaca vs Small intestine")
Cloaca_Rectum_ALDEX <- read.delim("aldexFinal_cloaca_rectum.txt", check.names = F)  %>% rename(
  rab.win.other="rab.win.Rectum") %>% mutate(compare="Cloaca vs Rectum")

table_feces_aldex<- rbind(Feces_Stomach_ALDEX, Feces_Intestine_ALDEX, Feces_Rectum_ALDEX)
table_cloaca_aldex<- rbind(Cloaca_Stomach_ALDEX, Cloaca_Intestine_ALDEX, Cloaca_Rectum_ALDEX)

p1<-table_feces_aldex %>% arrange(diff.btw)%>%#filter(!effect>abs(1))%>% 
  ggplot(., aes(x=diff.btw, y=reorder(names, diff.btw), fill=Type))+geom_bar(
  stat = "identity")+facet_wrap(~compare, ncol = 1, scales = "free")#+scale_y_discrete(labels=new_namex)

p2<-table_cloaca_aldex %>% arrange(diff.btw) %>% ggplot(., aes(x=diff.btw, y=reorder(names, diff.btw), fill=Type))+geom_bar(
  stat = "identity")+facet_wrap(~compare, ncol = 1, scales = "free")#+scale_y_discrete(labels=new_namex)

#new_namex<- c(1:28)

library(cowplot)
plot_grid(p1, p2, ncol = 2)

```

